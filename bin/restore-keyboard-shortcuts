#!/bin/bash

# Pop!_OS Keyboard Shortcuts Restore Script  
# Usage: restore-keyboard-shortcuts <backup-name>

BACKUP_DIR="$HOME/.config/keyboard-shortcuts-backups"

if [ $# -eq 0 ]; then
    echo "Usage: $0 <backup-name>"
    echo "Example: $0 current-setup"
    echo ""
    echo "Available backups:"
    ls -1 "$BACKUP_DIR" 2>/dev/null || echo "  (none found)"
    exit 1
fi

BACKUP_NAME="$1"
# Handle both bare names and full paths
if [[ "$BACKUP_NAME" == /* ]]; then
    BACKUP_FILE="$BACKUP_NAME"
else
    BACKUP_FILE="$BACKUP_DIR/$BACKUP_NAME"
fi

if [ ! -f "$BACKUP_FILE" ]; then
    echo "Error: Backup file '$BACKUP_FILE' not found"
    exit 1
fi

echo "Restoring keyboard shortcuts from: $BACKUP_FILE"

# Check if this is old format (gsettings list-recursively) or new format (dconf dump)
if head -5 "$BACKUP_FILE" | grep -q "^org\.gnome"; then
    echo "Detected old backup format. Converting to new format..."
    # This is old format, need to manually set each value
    grep -v '^#' "$BACKUP_FILE" | grep -v '^$' | while IFS= read -r line; do
        if [[ $line =~ ^([a-z.-]+)[[:space:]]+([a-z0-9-]+)[[:space:]]+(.+)$ ]]; then
            schema="${BASH_REMATCH[1]}"
            key="${BASH_REMATCH[2]}"
            value="${BASH_REMATCH[3]}"
            gsettings set "$schema" "$key" "$value" 2>/dev/null
        fi
    done
else
    # New format with dconf - proper restoration
    echo "This will overwrite your current keyboard shortcuts settings."
    read -p "Are you sure you want to continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Restore cancelled"
        exit 0
    fi
    
    # Strip comments and load with dconf
    grep -v '^#' "$BACKUP_FILE" | dconf load /
fi

echo "Keyboard shortcuts restore completed!"
echo "Restart GNOME Shell with: killall -3 gnome-shell"
